---
title: "P8015_Hw6_agd2159"
output: github_document
author: "Zander De Jesus"
date: "12-2-2023"
---

```{r Global Settings, message = FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
library(rnoaa)
library(patchwork)
set.seed(1234)

theme_set(theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1: Washington Post Homicide Data Exploration and Linear Modeling
Begin by importing and cleaning the csv in a similar method to Homework 5. This case study analysis asks us to create a binary categorical variable from case disposition, filter out more cities, and focus specifically on White and Black victims.

```{r Data Import}
wp_homicides = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) |> 
  mutate(city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)) |> 
  filter(victim_race %in% c("White", "Black")) |> 
  filter(!(city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO"))) |> 
  select(city_state, resolution, victim_age, victim_sex, victim_race)
```

First we will analyze a regression on Baltimore before applying the whole linear model to every city in the data set using a map function.

```{r}
baltimore_glm = 
  filter(wp_homicides, city_state == "Baltimore, MD") |> 
  glm(resolution ~ victim_age + victim_sex + victim_race, family = binomial(), data = _)

baltimore_glm |> 
  broom::tidy() |> 
  mutate(
    OR = exp(estimate), 
    OR_CI_upper = exp(estimate + 1.96 * std.error),
    OR_CI_lower = exp(estimate - 1.96 * std.error)) |> 
  filter(term == "victim_sexMale") |> 
  select(OR, OR_CI_lower, OR_CI_upper) |>
  knitr::kable(digits = 3)
```

The Odds Ratio displayed in this regression model is 0.426, and the 95% Confidence Interval does not include the null value of 1. Therefore, is statistical test indicates that the predictor variable male sex has a statistically significant association with reducing crime case resolution. 

The regression analysis in this general linear model is then expanded to all cities within the dataset using functions and unnesting subsequent analysis.

```{r All Cities}
fullcities_glm = wp_homicides |> 
  nest(data = -city_state) |> 
  mutate(
    models = map(data, \(df) glm(resolution ~ victim_age + victim_sex + victim_race, 
                                 family = binomial(), data = df)),
    cleaned_models = map(models, broom::tidy)) |> 
  select(-models, -data) |> 
  unnest(cols = cleaned_models) |> 
  mutate(
    OR = exp(estimate), 
    OR_CI_upper = exp(estimate + 1.96 * std.error),
    OR_CI_lower = exp(estimate - 1.96 * std.error)) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, OR, OR_CI_lower, OR_CI_upper)

fullcities_glm |> 
  slice(1:5) |> 
  knitr::kable(digits = 3)

```

Plotting these regression values together:
```{r}

fullcities_glm |> 
  mutate(city_state = fct_reorder(city_state, OR)) |> 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = OR_CI_lower, ymax = OR_CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The majority of cities in this regression analysis have odds ratios with CI's that are lower than the null value of one, indicating statistically signficiant assocation of lower case resolution for male victims. 3 cities, Fresno CA, Stockton, CA, and Albuquerque, NM, have positive statistically significant associations between male victims receiving closed cases.

# Problem 2: Bootstrapping Weather Data
```{r Data Import from API - Given in Prob. Instructions}

weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())

```

# Problem 3: Cross Validation Dataset
```{r Data Import and EDA}

birthweight_df = read_csv("data/birthweight.csv", na = c("", "NA", "Unknown")) |> 
  janitor::clean_names()

#Converting Categorical Variables from Factor to Numeric
birthweight_df = birthweight_df |> 
  mutate(babysex = as.factor(babysex),
         malform = as.factor(malform),
         frace = as.factor(frace),
         mrace = as.factor(mrace),
         )

```

